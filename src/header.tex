%%% Header for dissertation
%%% Caleb Stanford
%%% Summer 2022

% Official template:
% https://github.com/danieldeutsch/upenn-cis-templates/blob/master/thesis/thesis.tex

%% ========== Official Preamble ==========
% (with some minor modifications)

\usepackage[papersize={8.5 in, 11 in}, nohead, includeheadfoot, left=1.5 in, right = 1 in, vmargin= 1 in]{geometry}
% The options above are to set the paper size (as per page 11 of the guidelines and the margins. Includefoot is to make sure that nothing
% gets printed on the margins. The statutory margins are set on page 5.

\usepackage[doublespacing]{setspace} % Needed to set double-spacing for the main document, but needs more adhoc commands to
								% use single spacing for tables, etc.
\usepackage{calc}
% https://tex.stackexchange.com/questions/212710/fill-space-created-by-phantom-with-other-text
\newcommand{\textover}[3][l]{%
 % #1 is the alignment, default l
 % #2 is the text to be printed
 % #3 is the text for setting the width
 \makebox[\widthof{#3}][#1]{#2}%
}

\usepackage{microtype}

% For the signature boxes and much better looking tables
\usepackage{array} % Also for better arrays (eg matrices) in maths
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{makecell} % Line breaks in tables

% Commands to format the Table of Contents, List of Tables and List of Illustrations, as per the Wharton Template
\usepackage{tocloft}
\setcounter{tocdepth}{1} % Only show chapters and sections in ToC

% Change names and format of tables
\renewcommand{\contentsname}{TABLE OF CONTENTS}
\renewcommand{\cfttoctitlefont}{\large\hfill}
\renewcommand{\cftaftertoctitle}{\hfill}
\renewcommand{\cftbeforetoctitleskip}{-21 pt} % The key value here is the -21 pts, I got to it by old fashioned measuring with a ruler....
\renewcommand{\listtablename}{LIST OF TABLES}
\renewcommand{\cftlottitlefont}{\large\hfill}
\renewcommand{\cftafterlottitle}{\hfill}
\renewcommand{\cftbeforelottitleskip}{-21 pt} % The key value here is the -21 pts, I got to it by old fashioned measuring with a ruler....
% \renewcommand{\listfigurename}{LIST OF ILLUSTRATIONS}
\renewcommand{\listfigurename}{LIST OF FIGURES}
\renewcommand{\cftloftitlefont}{\large\hfill}
\renewcommand{\cftafterloftitle}{\hfill}
\renewcommand{\cftbeforeloftitleskip}{-21 pt} % The key value here is the -21 pts, I got to it by old fashioned measuring with a ruler....

% Format chapters (dots, including the word chapter, etc.)
\renewcommand{\cftchapfont}{\upshape}
\renewcommand{\cftchapleader}{\upshape\cftdotfill{\cftdotsep}}
\renewcommand{\cftchappagefont}{\upshape}
\renewcommand{\cftchappresnum}{CHAPTER }
\renewcommand{\cftchapaftersnum}{:}
\newlength{\mylen}   % a "scratch" length
\settowidth{\mylen}{\cftchappresnum \cftchapaftersnum} % extra space
\addtolength{\cftchapnumwidth}{\mylen} % add the extra space

%% Suppressing some annoying warnings
% "PDF inclusion: multiple pdfs with page group included in a single page"
% https://tex.stackexchange.com/a/78020/28267
\pdfsuppresswarningpagegroup=1
% "PDF inclusion: found PDF version <1.6>, but at most version <1.5> allowed"
% https://tex.stackexchange.com/questions/52317/pdftex-warning-version-allowed
\pdfminorversion=6
% "Package remreset Warning: The remreset package is obsolete"
% https://tex.stackexchange.com/questions/438543/what-to-do-when-an-actively-maintained-package-requires-an-obsolete-package
\RequirePackage{silence}
\WarningFilter{remreset}{The remreset package}
% Underfull hboxes due to hyperlinks in bibliography
% https://tex.stackexchange.com/questions/10924/underfull-hbox-in-bibliography
\usepackage{etoolbox}
\apptocmd{\sloppy}{\hbadness 10000\relax}{}{}

% Format tables in LoT
\renewcommand{\cfttableader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cfttabpresnum}{TABLE }
\renewcommand{\cfttabaftersnum}{:}
\newlength{\mylent}   % a "scratch" length
\settowidth{\mylent}{\cfttabpresnum \cfttabaftersnum} % extra space
\addtolength{\cfttabnumwidth}{\mylent} % add the extra space
\usepackage{remreset}

% Format Illusstrations in LoF
\renewcommand{\cftfigleader}{\cftdotfill{\cftdotsep}}
\renewcommand{\cftfigpresnum}{FIGURE }
\renewcommand{\cftfigaftersnum}{:}
\newlength{\mylenf}   % a "scratch" length
\settowidth{\mylenf}{\cftfigpresnum \cftfigaftersnum} % extra space
\addtolength{\cftfignumwidth}{\mylenf} % add the extra space

% Commands (more further down, at preliminary, main and appendix) to change the formatting of chapter headings
\usepackage[compact]{titlesec}
\renewcommand{\beforetitleunit}{0 pt}
\titleformat{\section}[hang]{\large}{\thesection.}{6 pt}{}
\titleformat{\subsection}[hang]{\normalsize\itshape}{\thesubsection.}{6 pt}{}
\titlespacing*{\section}{0pt}{20pt}{8pt}
\titlespacing*{\subsection}{0pt}{10pt}{6pt}

\usepackage{parskip} % To allow for better management of the Dutch paragraph style
\usepackage{url} % To allow for better typing of the url in the Creative Commons part of the copyright
% Revisit when checking against formatting and style guidelines
% \usepackage{natbib} % allows the author-date citation system
% \bibpunct{(}{)}{;}{a}{,}{,} % options for natbib to yield the citation style I like

% Other packages that are not needed for the template, but I highly recommend (and all of your own packages go here to)
% Add them one by one to make sure they do not interfere, for instance the package subfigure clashes with this template
\usepackage{amssymb}
% \usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{graphicx}
% \usepackage{longtable}
% \usepackage{dcolumn}
% \usepackage{longtable}
% \usepackage{rotating}
% \usepackage{xtab}               % collides on tablehead with glossaries
% \usepackage{paralist} % very flexible & customizable lists (eg. enumerate/itemize, etc.)
% \usepackage{verbatim}
% \usepackage{subfiles} % To be better able to manage large projects by compiling the separate files included in the final document

% Prevent orphans and widows
\widowpenalty10000
\clubpenalty10000

% FOR ADDING LINE NO. I have checked, this does not mess with margins (i.e. the # appears outside the margins, so no new orphans/widows are introduced)
% \usepackage{lineno}
% \linenumbers

%% TO TURN ON BIB FOR CHAPTER (when compiling chapters separately)
% \def\biblio{\bibliographystyle{abbrvnat}\bibliography{thesis}}
% %% TO TURN OFF BIB FOR EACH CHAPTER, (for compiling the whole thesis)
\def\biblio{}

%% ========== General ==========

% Clickable links & references
\usepackage{hyperref}
\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
}
% Abbreviation
\newcommand{\githubref}[2]{\href{#1}{#2}\footnote{\url{#1}}}

% Fix for TOC links: use \phantomsection
% Thanks to: https://tex.stackexchange.com/a/44091/28267
\providecommand\phantomsection{}

% Theorems and cleveref
% Cleveref must be loaded AFTER amsthm and BEFORE thm definitions.
% See: https://tex.stackexchange.com/questions/19104/cleveref-with-counters-with-same-name
\usepackage{amsthm}
\usepackage{cleveref}
% custom crefnames for \label optional argument
% https://tex.stackexchange.com/questions/200982/cleveref-reference-name-depending-on-label-instead-of-counter
\crefname{algorithm}{Algorithm}{Algorithms}

\theoremstyle{definition}
\newtheorem{theorem}{Theorem}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{example}[theorem]{Example}
\numberwithin{theorem}{section}

% Multiple bibliography -- primary references & other
\usepackage{multibib}
\newcites{Main}{PRIMARY REFERENCES}

% Inference rules
\usepackage{mathpartir}
\newcommand{\inference}[3][]{\inferrule*[Right=#1]{#2}{#3}}

%% ========== Document layout ==========

%% Roman Numerals
\makeatletter
\newcommand*{\romnum}[1]{\romannumeral #1\relax}
\newcommand*{\RomNum}[1]{\expandafter\@slowromancap\romannumeral #1@}
\makeatother

% Fancy custom section headers

\usepackage{changepage}
% \usepackage{titlesec}
% \titleformat{\section}[display]
%   {%
%     \clearpage\thispagestyle{empty}%
%     \normalfont\Large\bfseries\filcenter\titlerule[1pt]\vskip3pt%
%   }
%   {\RomNum{\thesection}.}
%   {-2pt}
%   {}
%   [{\vskip5pt\titlerule[1pt]\vspace{0.5cm}}]

\newcommand{\headerblock}[1]{
  \begin{adjustwidth}{2cm}{2cm}
  \begin{center}
    #1
  \end{center}
\end{adjustwidth}
  \vspace{0.5cm}
  % \clearpage
}
\newcommand{\headerquote}[2]{\textit{#1 \qquad} \\ \qquad ---#2}
\newcommand{\headerbreak}{\vspace{0.5cm}}

%% ========== Graphics and symbols ==========

\usepackage[dvipsnames]{xcolor}
\usepackage{graphbox} % allows using [align=c] argument to center vertically
\usepackage{stmaryrd} % Symbols like \llbracket, \rrbracket
\usepackage{pifont} % Symbols like \ding
\usepackage{relsize} % Large symbols (\mathlarger)

%% ========== TikZ ==========

\usepackage{tikz}
\usetikzlibrary{positioning, matrix, fit, arrows, shapes}
\usetikzlibrary{fit}

%% Block Diagrams
\tikzset{Block/.style={draw, rectangle, inner sep=4pt, align=center}}
\tikzset{Block Edge/.style={draw,thick,->}}
\tikzset{Data/.append style={fill=blue!20}}
\tikzset{Input/.append style={}}
\tikzset{Output/.append style={}}

%% Dataflow Graphs
\tikzset{source/.style={
        draw,
        rounded rectangle,
        inner sep=2pt,
        align=center,
        fill=blue!20
}}
\tikzset{operator/.style={
        draw,
        rectangle,
        inner sep=2pt,
        align=center
}}
\tikzset{sink/.style={
        draw,
        rounded rectangle,
        inner sep=2pt,
        align=center,
        fill=blue!20
}}
\tikzset{dataflowedge/.style={draw,thick,->}}

%% Topology Diagrams
\tikzset{Device Node/.style={draw,circle}}
\tikzset{Network/.style={draw,cloud,cloud puffs=10,cloud puff arc=120, aspect=2.5, inner sep=2pt}}
\tikzset{In Edge/.style={->,very thick,red}}
\tikzset{Out Edge/.style={->,very thick,blue}}

% Dependency Relations
\tikzset{Tag Node/.style={draw, circle, inner sep=0.5pt}}
\tikzset{Tag Edge/.style={draw, thick}}
\tikzset{Tag Loop/.style={draw, thick, in=245, out=305, looseness=5}}
\newcommand{\KeyDepGraph}[1]{
    \begin{tikzpicture}[baseline=(1.base)]
        \node[Tag Node] (1) at (0,0) {\tg{#1}$_1$};
        \draw (1) edge[Tag Loop] (1);
        \node[Tag Node] (2) at (1.2,0) {\tg{#1}$_2$};
        \node[draw=none,fill=none] at (2.1,0) {$\cdots$};
        \draw (2) edge[Tag Loop] (2);
        \node[Tag Node] (3) at (3,0) {\tg{#1}$_k$};
        \node[draw=none,fill=none] at (3.9,0) {$\cdots$};
        \draw (3) edge[Tag Loop] (3);
    \end{tikzpicture}}
\newcommand{\ExtendedKeyDepGraph}[1]{
    \begin{tikzpicture}[baseline=(1.base)]
        \node[Tag Node] (1) at (0,0) {\tg{#1}$_1$};
        \draw (1) edge[Tag Loop] (1);
        \node[Tag Node] (2) at (1.2,0) {\tg{#1}$_2$};
        \node[draw=none,fill=none] at (2.1,0) {$\cdots$};
        \draw (2) edge[Tag Loop] (2);
        \node[Tag Node] (3) at (3,0) {\tg{#1}$_k$};
        \node[draw=none,fill=none] at (3.9,0) {$\cdots$};
        \draw (3) edge[Tag Loop] (3);
        \node[Tag Node] (4) at (1.6,1.2) {\tg{EOD}};
        \draw (4) edge[Tag Loop, in=65, out=115] (4);
        \draw (1) edge[Tag Edge] (4);
        \draw (2) edge[Tag Edge] (4);
        \draw (3) edge[Tag Edge] (4);
        \node[Tag Node] (5) at (0,1.2) {\tg{EOM}};
        \draw (5) edge[Tag Loop, in=65, out=115] (5);
        \draw (4) edge[Tag Edge] (5);
    \end{tikzpicture}}

%% Update/fork/join computations
\tikzset{B/.style={draw, inner sep=0pt, circle, font=\footnotesize{}, minimum size=16pt}}
% minimum size=16pt
% regular polygon, regular polygon sides=4,font=\footnotesize}}
\tikzset{E/.style={draw,->}}
\tikzset{W/.style={draw, font=\small}}

% Dependency graphs
\newcommand{\TwoTagDepGraph}[3]{
    \begin{tikzpicture}[baseline=(1.base)]
        \node[Tag Node] (1) at (210:0.5) {\footnotesize #1};
        \node[Tag Node] (2) at (330:0.5) {\footnotesize #2};
        #3
    \end{tikzpicture}}

% Synchronization plans
\newcommand{\TopConfigNode}[3]{
    \begin{tabular}{c | c }
        #1 & \{ #2 \} \\
        \hline
        \multicolumn{2}{c}{#3}
    \end{tabular}
}
\newcommand{\ConfigurationNode}[3]{
    node { \TopConfigNode{#1}{#2}{#3} } }
\newcommand{\TopWorkerNode}[3]{
    \begin{tabular}{c}
        #1 \\
        \hline
        \{ #2 \} \\
        {#3}
    \end{tabular}
}
\newcommand{\TopDNode}[4]{
    \TopConfigNode{#1}{#2}{#4}
}
\newcommand{\DNode}[5]{
    node (#5) { \TopDNode{#1}{#2}{#3}{#4} }
}

% For schema diagram in sec 4
\newcommand{\TopSchemaNode}[1]{#1}
\newcommand{\SchemaNode}[2]{node (#2) { \TopSchemaNode{#1} } }
% The KeyBy Node takes 4 arguments: the keys; the node name; the top node
% child of the KeyBy Node; and the leaf of the KeyBy Node (to fit around it)
\newcommand{\KeyByNode}[4]{
    \node (#2) [above=1mm of #3.north west, draw=none] {#1};
    \node [draw=black!50, fit={(#3) (#4) (#2)}, double, rounded corners=0] (#2') {}
}

%% ========== Code and Pseudocode Customization ==========

\usepackage{algorithm, caption}
\usepackage[noend]{algpseudocode} % (layout for algorithmicx)
\usepackage{subcaption}
\captionsetup{compatibility=false} % Fix compatibility error
\usepackage{listings}
% \usepackage{lstlinebgrd}

%% Listings
\lstset{language=Java,
  showspaces=false,
  showtabs=false,
  breaklines=true,
  showstringspaces=false,
  breakatwhitespace=true,
  commentstyle=\color{gray},
  keywordstyle=\color{blue},
  stringstyle=\color{red},
  basicstyle=\ttfamily\footnotesize,
  frame = single,
  numbersep = 0,
  resetmargins = true
}
\newcommand{\inljava}[1]{\lstinline[columns=fixed, basicstyle=\ttfamily\small]{#1}}

%% Algorithmic
\renewcommand{\algorithmicrequire}{\textbf{Input:}}
\renewcommand{\algorithmicensure}{\textbf{Output:}}
\algblockdefx[OnElement]{OnElement}{EndOnElement}%
  [2]{\textbf{on new element }#1\textbf{ in stream }#2\textbf{:}}%
  {\textbf{done}}
\algblockdefx[OnEmptyStreams]{OnEmptyStreams}{EndOnEmptyStreams}%
  {\textbf{on both streams empty:}}%
  {\textbf{done}}
\makeatletter
\ifthenelse{\equal{\ALG@noend}{t}}%
  {\algtext*{EndOnElement} \algtext*{EndOnEmptyStreams}}%
  {}%
\makeatother

%% For Flumina
% Also for data transducer constructions
\usepackage{tcolorbox}
\newenvironment{takeaway}{
\begin{tcolorbox}[colback=blue!5!white,colframe=blue!5!white,arc=0mm,grow to left by=1.5mm,left=1mm,grow to right by=1.5mm,right=1mm,top=.5mm,bottom=.5mm]
}
{
\end{tcolorbox}
}
\newenvironment{dtbox}{
\begin{tcolorbox}[colback=blue!5!white,colframe=blue!5!white,arc=0mm,grow to left by=1.5mm,left=1mm,grow to right by=1.5mm,right=1mm,top=.5mm,bottom=.5mm]
}
{
\end{tcolorbox}
}

%% Table coloring -- for Flumina evaluation table
\usepackage{colortbl}
\definecolor{ColBlue}{RGB}{227, 252, 252}
\definecolor{ColPink}{RGB}{245, 208, 229}
\definecolor{ColYellow}{RGB}{247, 247, 205}
\newcolumntype{F}{>{\columncolor{ColBlue}}c} % Flink
\newcolumntype{O}{>{\columncolor{ColYellow}}c} % Ours -- DGS
\newcolumntype{T}{>{\columncolor{ColPink}}c} % Timely

\lstset{
    numbers=none,
    % numberstyle=\tiny\color{black},
    basicstyle=\ttfamily\footnotesize,
    basewidth=0.59em,
    keywordstyle=[3]{},
    commentstyle=\itshape\footnotesize,
    tabsize=8,
    % frame=single,
    % frameround=tttt,
    showstringspaces=false,
    breaklines=false,
    captionpos=b,
    aboveskip=\bigskipamount,
    belowskip=\bigskipamount,
    escapechar=^
}

%% Erlang Code

\lstdefinestyle{custom}{
    numbers=none,
    % numberstyle=\tiny\color{black},
    basicstyle=\ttfamily\footnotesize,
    basewidth=0.59em,
    keywordstyle=[3]{},
    commentstyle=\itshape\footnotesize,
    tabsize=8,
    % frame=single,
    % frameround=tttt,
    showstringspaces=false,
    rulecolor=\color{black},
    breaklines=false,
    captionpos=b,
    aboveskip=\bigskipamount,
    belowskip=\bigskipamount,
    escapechar=^,
    moredelim=**[is][\color{blue}]{@}{@}
}

\newcommand{\inle}[1]{\lstinline[columns=fixed,language=Erlang,style=custom]{#1}}

%% Flumina code
\definecolor{PigBlue}{RGB}{30, 0, 200}
\definecolor{PigRed}{RGB}{150, 0, 0}
\definecolor{PigGreen}{RGB}{0, 128, 0}
\lstdefinelanguage{Flumina}
{
    keywords=[1]{
        if, else, for, in, return, output, new, match, with
    },
    keywordstyle=[1]\bfseries,
    keywords=[2]{
        init,
        dependencies,
        fork, join,
        update, update_i, update_s, update_o,
        out, out_i,
        pred_i, pred_0, pred_j
    },
    keywordstyle=[2]\color{PigRed},
    keywords=[3]{
        Map, Set, List,
        Event, State, Integer, Key, Out, Tag, Payload, Heartbeat,
        State_i, State_j, State_k, State_0, State_1, State_2,
        State1, State2,
        Pred,
        List
    },
    keywordstyle=[3]\color{PigBlue},
    sensitive=true,
    morestring=[b]',
    morecomment=[l][\color{black!70}]{//},
    basicstyle=\small\ttfamily
    % basicstyle=\small %, %or \small or \footnotesize etc.]
}

\lstnewenvironment{FluminaCode}{
  \nopagebreak
  \lstset{language=Flumina}}{}

\newcommand{\fl}[1]{\text{\lstinline[
    language=Flumina,
    columns=fullflexible,
    basicstyle=\footnotesize\ttfamily
]!#1!}}
